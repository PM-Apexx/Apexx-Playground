<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Demo</title>
  <link rel="stylesheet" href="./styles.css" />
  <!-- Styles and other head elements -->
</head>
<body class="light">
  <script>
    // Check if the page is loaded within an iframe or as the top-level document
    if (window.self !== window.top) {
      // JavaScript for managing payment, embedded directly for iframe context
      class CustomApiClient {
        constructor(baseUrl, apiKey) {
          this.baseUrl = baseUrl;
          this.apiKey = apiKey;
        }

        async sendRequest(endpoint, method = 'POST', requestData = null) {
          const url = `${this.baseUrl}/${endpoint}`;
          const options = {
            method,
            headers: {
              'Content-Type': 'application/json',
              'X-APIKEY': this.apiKey
            },
          };

          if (requestData) {
            options.body = JSON.stringify(requestData);
          }

          try {
            const response = await fetch(url, options);
            const responseData = await response.json();

            if (!response.ok) {
              throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
            }

            return responseData;
          } catch (error) {
            throw new Error(`Error occurred while sending API request: ${error.message}`);
          }
        }
      }

      const customApiKey = '473be873A0912A4eedAb26cA2edf67bb4faa';
      const customBaseUrl = 'https://sandbox.apexx.global/atomic/v1/api/payment/hosted';
      const customApiClient = new CustomApiClient(customBaseUrl, customApiKey);

      let customPaymentInitiated = false; // Flag to track if payment has been initiated

      const customPaymentData = {
        organisation: '4d1a4e9dAaff5A4b7aAa200A21d072d2e4ca',
        currency: 'GBP',
        amount: 100,
        capture_now: true,
        dynamic_descriptor: 'Demo Merchant Test Purchase',
        merchant_reference: 'ghjhgjhghfgf',
        return_url: 'https://sandbox.apexx.global/atomic/v1/api/return',
        webhook_transaction_update: 'https://webhook.site/63250144-1263-4a3e-a073-1707374c5296',
        transaction_type: 'first',
        duplicate_check: false,
        locale: 'en_GB',
        card: {
          create_token: true
        },
        billing_address: {
          first_name: 'FIRSTNAME',
          last_name: 'LASTNAME',
          email: 'EMAIL@DOMAIN.COM',
          address: '12',
          city: 'CITY',
          state: 'STATE',
          postal_code: '34',
          country: 'GB',
          phone: 44123456789
        },
        three_ds: {
          three_ds_required: true,
          three_ds_version: '2.0'
        }
      };

      document.addEventListener('DOMContentLoaded', function() {
        const paymentOptionRadio = document.getElementById('cards');
        paymentOptionRadio.addEventListener('change', function() {
          const paymentForm = document.getElementById('payment-form');
          paymentForm.style.display = 'block';
        });

        const paymentButton = document.getElementById('paymentButton');
        paymentButton.addEventListener('click', redirectToPaymentPage);

        const inputs = document.querySelectorAll('#inputs input');
        inputs.forEach(input => {
          input.addEventListener('input', function() {
            const cardholder = document.getElementById('cardholder').value;
            const cardNumber = document.getElementById('card-number').value;
            const expiryDate = document.getElementById('expiry-date').value;
            const cvv = document.getElementById('cvv').value;

            if (cardholder && cardNumber && expiryDate && cvv) {
              paymentButton.removeAttribute('disabled');
            } else {
              paymentButton.setAttribute('disabled', 'disabled');
            }
          });
        });
      });

      const redirectToPaymentPage = () => {
        if (!customPaymentInitiated) {
          customApiClient.sendRequest('', 'POST', customPaymentData)
            .then(responseData => {
              console.log('API Response Data:', responseData);
              if (responseData && responseData.url) {
                console.log('Redirecting to:', responseData.url);
                window.location.href = responseData.url; // Redirecting to the received URL
                customPaymentInitiated = true; // Update flag to indicate payment initiated
              }
            })
            .catch(error => {
              console.error('Error occurred while sending API request:', error);
              displayPaymentOutcome(false); // Display payment failure outcome
            });
        } else {
          // Prevents reloading the page if payment has already been initiated
          console.log('Payment has already been initiated.');
        }
      };

      const displayPaymentOutcome = (success) => {
        const outcomeDiv = document.getElementById('outcome');
        outcomeDiv.textContent = success ? 'Payment Successful' : 'Payment Failed';
      };
    } else {
      // When loaded as top-level document, dynamically create and append the iframe
      document.write(`
        <h2>Payment Section</h2>
        <iframe src="https://pm-apexx.github.io/Apexx-Playground/" width="100%" height="600" frameborder="0"></iframe>
      `);
    }
  </script>
</body>
</html>
